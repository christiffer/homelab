# K3s agent role - joins Pis to the K3s cluster

---
- name: Check if K3s is already installed
  stat:
    path: /usr/local/bin/k3s
  register: k3s_binary

- name: Download K3s install script
  get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s-install.sh
    mode: '0755'
  when: not k3s_binary.stat.exists

- name: Install K3s agent
  shell: |
    INSTALL_K3S_VERSION="{{ k3s_version }}" \
    K3S_URL="{{ k3s_server_url }}" \
    K3S_TOKEN="{{ k3s_token }}" \
    /tmp/k3s-install.sh agent
  args:
    creates: /usr/local/bin/k3s
  when:
    - not k3s_binary.stat.exists
    - k3s_token is defined

- name: Apply node labels
  shell: |
    kubectl label node {{ inventory_hostname }} {{ item }} --overwrite
  loop: "{{ k3s_node_labels | default([]) }}"
  delegate_to: "{{ groups['k3s_server'][0] | default('localhost') }}"
  when: k3s_node_labels is defined
  ignore_errors: true  # May fail if node hasn't joined yet

- name: Ensure K3s agent service is enabled and running
  service:
    name: k3s-agent
    enabled: true
    state: started
  when: k3s_binary.stat.exists or k3s_token is defined
